// Prisma Schema for Hack-The-Box Competition Platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

enum Role {
  PARTICIPANT
  ADMIN
  JUDGE
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  username      String   @unique
  passwordHash  String
  role          Role     @default(PARTICIPANT)
  isActive      Boolean  @default(true)
  isDisqualified Boolean @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  team          Team?
  submissions   Submission[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([username])
  @@map("users")
}

model Team {
  id             String   @id @default(uuid())
  name           String   @unique
  userId         String   @unique
  totalScore     Int      @default(0)
  lastSubmission DateTime?
  isDisqualified Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  submissions Submission[]
  scoreAdjustments ScoreAdjustment[]

  @@index([totalScore])
  @@index([userId])
  @@map("teams")
}

// ==========================================
// EVENT & ROUNDS
// ==========================================

enum RoundState {
  LOCKED
  ACTIVE
  ENDED
}

model Round {
  id          String      @id @default(uuid())
  number      Int         @unique
  name        String
  description String?
  state       RoundState  @default(LOCKED)
  startedAt   DateTime?
  endedAt     DateTime?
  order       Int         @unique
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  challenges Challenge[]

  @@index([number])
  @@index([state])
  @@map("rounds")
}

// ==========================================
// CHALLENGES
// ==========================================

enum ChallengeType {
  CRYPTO
  HASH_CRACK
  CTF
  GENERAL
}

model Challenge {
  id              String         @id @default(uuid())
  roundId         String
  title           String
  description     String
  type            ChallengeType
  points          Int
  flagHash        String         // Hashed flag for security
  maxAttempts     Int            @default(0) // 0 = unlimited
  isActive        Boolean        @default(true)
  isFinalFlag     Boolean        @default(false)
  order           Int
  hints           String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  round           Round          @relation(fields: [roundId], references: [id], onDelete: Cascade)
  submissions     Submission[]

  @@index([roundId])
  @@index([isActive])
  @@map("challenges")
}

// ==========================================
// SUBMISSIONS & SCORING
// ==========================================

model Submission {
  id            String   @id @default(uuid())
  teamId        String
  userId        String
  challengeId   String
  submittedFlag String
  isCorrect     Boolean
  points        Int      @default(0)
  attemptNumber Int      @default(1)
  ipAddress     String?
  userAgent     String?
  submittedAt   DateTime @default(now())

  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([challengeId])
  @@index([isCorrect])
  @@index([submittedAt])
  @@map("submissions")
}

model ScoreAdjustment {
  id          String   @id @default(uuid())
  teamId      String
  adminId     String
  points      Int
  reason      String
  createdAt   DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@map("score_adjustments")
}

// ==========================================
// SYSTEM CONFIGURATION
// ==========================================

model EventConfig {
  id               String   @id @default(uuid())
  eventName        String   @default("HACK-THE-BOX")
  tagline          String   @default("Decode. Discover. Defend.")
  duration         Int      @default(180) // minutes
  isActive         Boolean  @default(false)
  startedAt        DateTime?
  endedAt          DateTime?
  scoreboardFrozen Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("event_config")
}

// ==========================================
// AUDIT & LOGGING
// ==========================================

enum AuditAction {
  LOGIN
  LOGOUT
  SUBMIT_FLAG
  ROUND_STATE_CHANGE
  CHALLENGE_STATE_CHANGE
  SCORE_ADJUSTMENT
  TEAM_DISQUALIFY
  EXPORT_RESULTS
}

model AuditLog {
  id          String      @id @default(uuid())
  userId      String?
  action      AuditAction
  targetType  String?
  targetId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
